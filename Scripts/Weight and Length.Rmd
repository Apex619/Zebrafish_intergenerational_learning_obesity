---
title: "Weight and Length"
author: "Hamza"
date: "23/11/2020"
output: html_document
---

### Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#checks for installation and loads packages
pacman::p_load(lmerTest,ggThemeAssist,rptR,lme4,readxl, tidyr, dplyr, magrittr, lubridate, stringr, purrr,
               sjPlot,ggplot2,lubridate,wesanderson,ggbeeswarm,emmeans,patchwork,viridis,nlme,Rmisc,ggpubr,
               stargazer)

# Load custom functions
source("Scripts/functions_learning.R")
source("Scripts/functions_repeatability.R")

#Run this after all the coding has been run with 10,000 bootstraps
save.image(file='myEnvironment.RData') 
#load('myEnvironment.RData')
```

#Import and filter data
```{r, include = FALSE}
#Master file with raw data
Weight_Length_Data <- read.csv("../Data/Weight_Length/Weight_Length.csv")

#Subseting data by control and treatment
Weight_Length_Maternal <- subset(Weight_Length_Data, Weight_Length_Data$Set == "Maternal") 
Weight_Length_Paternal <- subset(Weight_Length_Data, Weight_Length_Data$Set == "Paternal") 
Weight_Length_Control <- subset(Weight_Length_Data, Weight_Length_Data$Set == "Within Control") 
Weight_Length_Treatment <- subset(Weight_Length_Data, Weight_Length_Data$Set == "Within Treatment") 
```

### REPEATABILITY ANALYSIS FOR BODY WEIGHT AND LENGTH 
1) CHECKING NORMALITY ASSUMPTIONS WITH MIXED MODELS AND A HISTOGRAM OF RESIDUALS
2) PERFORMING REPEATABILITY ANALYSIS AND EXTRACTING WITHIN-AND BETWEEN-INDIVIDUAL VARIANCES AFTER A Z TRANSFORMATION (FOR BOTH CONTROL AND TREATMENT)
3) CALCULATING DIFFERENCES BETWEEN REPEATABILITIES
4) FINAL MIXED MODEL USING LME FUNCTION
5) CALCULATING VARIANCE DIFFERENCES BETWEEN CONTROL AND TREATMENT GROUPS

# Body Weight
```{r, echo=FALSE}

#Check Normality with mixed model and then histogram of residuals

Model_Body_Weight <- lmer(Weight_g ~ Set + Sex + Age_Weeks + (1 | Fish_ID), data = Weight_Length_Data) #mixed model 
tab_model(Model_Body_Weight)
hist(residuals(Model_Body_Weight))#histogram of residuals to check for normal distribution 

Model_Body_Weight2 <- lmer(Weight_g ~ Set*Age_Weeks + Sex*Age_Weeks + (1 | Fish_ID) + (1 + Age_Weeks|Set), data = Weight_Length_Data) 
summary(Model_Body_Weight2)
tab_model(Model_Body_Weight2)
hist(residuals(Model_Body_Weight2))



#Calculating repeatabilities (without week and with week)
rpt_weight(Weight_Length_Control) -> rpt_body_weight_control #without week factored in
rpt_body_weight_control
rpt_weight(Weight_Length_Treatment) -> rpt_body_weight_treatment #without week factored in
rpt_body_weight_treatment
rpt_weight2(Weight_Length_Control) -> rpt_body_weight_control2 #adjusted for week
rpt_body_weight_control2
rpt_weight2(Weight_Length_Treatment) -> rpt_body_weight_treatment2 #adjusted for week
rpt_body_weight_treatment2



#Obtaining within-individual and between-individual variance for body weight

rpt_within_weight(Weight_Length_Control) -> within_between_body_weight_control
rpt_within_weight(Weight_Length_Treatment) -> within_between_body_weight_treatment

rpt_within_weight2(Weight_Length_Control) -> within_between_body_weight_control2 #adjusted for week
rpt_within_weight2(Weight_Length_Treatment) -> within_between_body_weight_treatment2 #adjusted for week


#Obtaining differences between repeatabilities using custom made functions
Control_weight_boot <- unlist_rptr(rpt_body_weight_control) 
Treatment_weight_boot <- unlist_rptr(rpt_body_weight_treatment) 
body_weight_diff <- difference_boot(Control_weight_boot,Treatment_weight_boot) #calculating the difference
q_body_weight <- quantiles_diff_boot(body_weight_diff) #obtaining 95% CI
m_mody_weight <- mean(body_weight_diff) #Obtaining mean

q_body_weight
m_mody_weight

# Calculating difference in variance between control and treatment group 
Model_Weight_1 <- lme(Weight.g. ~ (Treatment_Tank + Sex + Week)^2, random = ~ 1| Fish_ID, data = Weight_Length_Data) #Mixed model without variance structure
summary(Model_Weight_1)
Model_Weight_2 <- lme(Weight.g. ~ (Treatment_Tank + Sex + Week)^2, random = ~ 1| Fish_ID, weights = varIdent(form=~1|Treatment_Tank), data = Weight_Length_Data) #mixed model with variance structure varIdent
summary(Model_Weight_2)
anova(Model_Weight_1, Model_Weight_2) #calculating difference between two models to find difference in variance
```