---
title: "analysis"
output: html_document
---

### Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#checks for installation and loads packages
         

# Load custom function to extract data 
source("../Scripts/functions_learning.R")
```

#Subset data into control and treatment groups and then by sex
```{r}
#Subsetting data by control and treatment
Learning_Control <- subset(p2cs, p2cs$Tank == "Within_Control") 
Learning_Treatment <- subset(p2cs, p2cs$Tank == "Within_Treatment") 
Learning_Maternal <- subset(p2cs, p2cs$Tank == "Maternal") 
Learning_Paternal <- subset(p2cs, p2cs$Tank == "Paternal") 



#Subset by sex

#Control and treatment males and females 
Control_Male_Learning <- subset(Learning_Control, Learning_Control$sex == "male")
Control_Female_Learning <- subset(Learning_Control, Learning_Control$sex == "female")
Treatment_Male_Learning <- subset(Learning_Treatment, Learning_Treatment$sex == "male")
Treatment_Female_Learning <- subset(Learning_Treatment, Learning_Treatment$sex == "female")
Maternal_Male_Learning <- subset(Learning_Maternal, Learning_Maternal$sex == "male")
Maternal_Female_Learning <- subset(Learning_Maternal, Learning_Maternal$sex == "female")
Paternal_Male_Learning <- subset(Learning_Paternal, Learning_Paternal$sex == "male")
Paternal_Female_Learning <- subset(Learning_Paternal, Learning_Paternal$sex == "female")
```

### MAIN ANALYSIS 
1) CHECKING NORMALITY ASSUMPTIONS WITH MIXED MODELS AND A HISTOGRAM OF RESIDUALS
2) PERFORMING REPEATABILITY ANALYSIS FOR EACH GROUP AND EXTRACTING WITHIN-AND BETWEEN-INDIVIDUAL VARIANCES AFTER A Z TRANSFORMATION
3) CALCULATING DIFFERENCES BETWEEN REPEATABILITIES
4) FINAL MIXED MODEL USING LME FUNCTION
5) CALCULATING VARIANCE DIFFERENCES BETWEEN CONTROL AND TREATMENT

```{r}
#Check Normality with mixed model and then histogram of residuals

Model_Learning <- lmer(difference ~ Tank + sex + (1 | fishID), data = p2cs) 
tab_model(Model_Learning)
hist(residuals(Model_Learning)) 

learning_f1 <- ggplot(p2cs, aes(x=Tank, y=difference, fill = Tank)) + 
  geom_violin()+
  geom_jitter(height = 0, width = 0.1)+
  facet_grid(~sex)

#Contrasts 
em_tank <- emmeans(Model_Learning, ~ Tank) 
pairs(em_tank)

Model_Learning_p5 <- lmer(difference ~ Tank + sex + (1 | fishID), data = p5cs) 
tab_model(Model_Learning_p5)

#Calculating repeatabilities using custom made functions
rpt_learning(Learning_Control) -> rpt_learning_control
rpt_learning_control
rpt_learning(Learning_Treatment) -> rpt_learning_treatment
rpt_learning_treatment

rpt_learning(Learning_Maternal) -> rpt_learning_Maternal
rpt_learning_Maternal
rpt_learning(Learning_Paternal) -> rpt_learning_Paternal
rpt_learning_Paternal


# Calculating difference in variance between control and treatment groups
Model_Learning1 <- lme(difference ~ Tank + sex, random = ~ 1| fishID, data = p2cs, na.action=na.exclude) #mixed model without variance structure
summary(Model_Learning1)
Model_Learning2 <- lme(difference ~ Tank + sex, random = ~ 1| fishID, weights = varIdent(form=~1|Tank), data = p2cs, na.action=na.exclude) #mixed model with variance structure varIdent
summary(Model_Learning2)
anova(Model_Learning1, Model_Learning2) #calculating difference between two models to find difference in variance

#Quick Visualization
p2cs %>%
  ggplot(aes(Tank, difference, fill=Tank)) +
  geom_violin(
    trim = FALSE,
    draw_quantiles = c(0.25, 0.5, 0.75), 
    alpha=0.5
  ) + 
  geom_point(position = "jitter", alpha = 0.7, size = 3)+
  facet_grid(~sex)
```

#Sex Analysis

```{r}

#Calculating repeatabilities using custom made functions for males (control and treatment)
rpt_learning(Control_Male_Learning) -> rpt_learning_control_male
rpt_learning_control_male
rpt_learning(Treatment_Male_Learning) -> rpt_learning_treatment_male
rpt_learning_treatment_male

#Calculating repeatabilities using custom made functions for females (control and treatment)
rpt_learning(Control_Female_Learning) -> rpt_learning_control_female
rpt_learning_control_female
rpt_learning(Treatment_Female_Learning) -> rpt_learning_treatment_female
rpt_learning_treatment_female

#Calculating repeatabilities using custom made functions for males (Maternal and Paternal)
rpt_learning(Maternal_Male_Learning) -> rpt_learning_Maternal_male
rpt_learning_Maternal_male
rpt_learning(Paternal_Male_Learning) -> rpt_learning_Paternal_male
rpt_learning_Paternal_male

#Calculating repeatabilities using custom made functions for females (Maternal and Paternal)
rpt_learning(Maternal_Female_Learning) -> rpt_learning_Maternal_female
rpt_learning_Maternal_female
rpt_learning(Paternal_Female_Learning) -> rpt_learning_Paternal_female
rpt_learning_Paternal_female


#Quick Visualization
p2cs %>%
  ggplot(aes(Tank, difference, fill=Tank)) +
  geom_violin(
    trim = FALSE,
    draw_quantiles = c(0.25, 0.5, 0.75), 
    alpha=0.5
  ) + 
  geom_point(position = "jitter", alpha = 0.7, size = 3)+
  facet_grid(~sex)
```
